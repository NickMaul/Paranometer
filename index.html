<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Paranometer — Energielevel Tester</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#02040a;
    --bg2:#07121a;
    --card:#061018;
    --neon:#7ef9b6;
    --neon-2:#7cf0ff;
    --muted:rgba(190,255,220,0.12);
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%; margin:0; font-family:"Space Grotesk",system-ui,Segoe UI,Roboto,Helvetica,Arial; background:radial-gradient(1200px 600px at 10% 10%, rgba(0,255,150,0.02), transparent 6%), linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 100%); color:var(--neon); -webkit-font-smoothing:antialiased;}
  .wrap{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px;}
  .panel{width:min(980px,96vw); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:16px; padding:20px; box-shadow: 0 12px 40px rgba(1,6,10,0.6); border:1px solid rgba(124,240,255,0.03);}
  .head{display:flex; align-items:center; gap:14px;}
  .logo{width:58px; height:58px; background:linear-gradient(135deg, rgba(126,249,182,0.12), rgba(124,240,255,0.06)); border-radius:10px; display:flex; align-items:center; justify-content:center; color:var(--neon-2); font-weight:700; font-size:22px; box-shadow: 0 6px 20px rgba(12,255,170,0.03) inset;}
  h1{margin:0; font-size:20px; letter-spacing:0.6px; color:var(--neon-2);}
  p.lead{margin:6px 0 0 0; color:rgba(200,255,220,0.9); font-size:13px; opacity:0.95;}
  
  .mainrow{display:flex; gap:18px; margin-top:18px; align-items:stretch; flex-wrap:wrap;}
  .left{flex:1 1 380px; min-width:300px; background:var(--card); border-radius:12px; padding:16px; border:1px solid var(--muted);}
  .right{width:320px; min-width:260px; background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent); border-radius:12px; padding:14px; border:1px solid var(--muted);}
  
  /* Gauge */
  .gauge-wrap{display:flex; align-items:center; justify-content:center; position:relative; padding:8px;}
  .gauge{width:320px; height:160px; position:relative; transform: translateY(6px);}
  .gauge-face{position:absolute; left:0; top:0; width:100%; height:100%; border-radius:160px 160px 0 0; overflow:hidden; display:flex; align-items:end; justify-content:center; background:linear-gradient(180deg, rgba(20,40,30,0.04), rgba(0,0,0,0)); box-shadow: inset 0 -6px 18px rgba(0,0,0,0.4);}
  .gauge-arc{position:absolute; inset:6px; border-radius:160px 160px 0 0; background: linear-gradient(90deg, rgba(126,249,182,0.06), rgba(124,240,255,0.035)); }
  .gauge-center{position:absolute; left:50%; bottom:-6px; transform:translateX(-50%); width:12px; height:12px; border-radius:50%; background:var(--neon-2); box-shadow:0 0 12px rgba(124,240,255,0.6);}
  
  /* needle */
  .needle-wrap{position:absolute; left:50%; bottom:8px; width:6px; height:120px; transform-origin:50% 92%; pointer-events:none;}
  .needle{position:absolute; left:50%; bottom:0; width:6px; height:92px; transform-origin:50% 92%; background:linear-gradient(180deg, var(--neon), rgba(0,0,0,0.15)); border-radius:4px; box-shadow:0 6px 24px rgba(30,255,150,0.06), 0 0 20px rgba(126,249,182,0.06) inset; transform:rotate(-90deg);}
  .needle::after{content:""; position:absolute; left:50%; top:-12px; transform:translateX(-50%); width:18px; height:18px; border-radius:50%; background:var(--neon-2); box-shadow:0 0 20px rgba(124,240,255,0.8);}
  /* needle shake animation for strong reading */
  @keyframes needle-vibe {
    0% { transform: rotate(var(--angle)); }
    25% { transform: rotate(calc(var(--angle) + 1.8deg)); }
    50% { transform: rotate(calc(var(--angle) - 1.2deg)); }
    75% { transform: rotate(calc(var(--angle) + 0.9deg)); }
    100% { transform: rotate(var(--angle)); }
  }
  .needle.vibrating { animation: needle-vibe 0.18s infinite linear; }

  /* tick labels */
  .ticks{position:absolute; left:0; top:6px; width:100%; height:100%; pointer-events:none;}
  .tick{position:absolute; left:50%; bottom:8px; transform-origin:50% 92%; background:transparent; color:var(--neon); font-size:12px; text-shadow: 0 0 6px rgba(0,255,170,0.04);}
  .lbl{position:absolute; transform:translateX(-50%); bottom:6px; font-size:11px; color:rgba(190,255,220,0.85); opacity:0.95;}
  
  /* controls */
  .controls{display:flex; gap:10px; margin-top:8px; align-items:center; flex-wrap:wrap;}
  button.primary{background:linear-gradient(180deg,var(--neon), var(--neon-2)); color:#002426; border:none; padding:10px 14px; font-weight:700; border-radius:10px; box-shadow: 0 8px 30px rgba(126,249,182,0.08); cursor:pointer;}
  button.ghost{background:transparent; color:var(--neon); border:1px solid rgba(126,249,182,0.08); padding:8px 12px; border-radius:10px; cursor:pointer;}
  .small{font-size:13px; color:rgba(200,255,220,0.9);}
  .meter{display:flex; gap:8px; margin-top:12px; align-items:center; justify-content:space-between;}
  .meter .bar{height:10px; background:rgba(126,249,182,0.06); border-radius:999px; flex:1; overflow:hidden; border:1px solid rgba(255,255,255,0.02);}
  .meter .bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, rgba(126,249,182,0.8), rgba(124,240,255,0.6)); box-shadow:0 8px 18px rgba(30,255,150,0.06); border-radius:999px; transition: width 0.12s linear;}
  
  /* readouts */
  .readouts{display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:10px;}
  .tile{background:var(--glass); padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); font-size:13px;}
  .tile .num{font-size:18px; font-weight:700; color:var(--neon-2);}

  footer.note{margin-top:14px; font-size:12px; color:rgba(180,255,200,0.6); opacity:0.9;}
  
  /* modal */
  .modal-back{position:fixed; inset:0; background:linear-gradient(90deg, rgba(0,0,0,0.55), rgba(0,0,0,0.75)); display:none; align-items:center; justify-content:center; z-index:60;}
  .modal{width:min(720px,92vw); background:linear-gradient(180deg, rgba(6,16,20,0.95), rgba(4,8,12,0.98)); border-radius:12px; padding:18px; border:1px solid rgba(130,255,200,0.03);}
  .modal h2{margin:0; color:var(--neon-2);}
  .modal .desc{margin-top:8px; color:rgba(200,255,220,0.95); font-size:14px;}
  .modal .row{display:flex; gap:12px; margin-top:12px; flex-wrap:wrap;}
  .modal .bigval{font-size:34px; color:var(--neon-2); font-weight:800;}
  .modal .meaning{margin-top:10px; font-size:14px; color:rgba(200,255,220,0.95);}

  /* responsive */
  @media (max-width:820px){
    .mainrow{flex-direction:column;}
    .right{width:100%;}
    .gauge{width:100%; height:160px;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="panel" role="main" aria-live="polite">
      <div class="head">
        <div class="logo">P</div>
        <div>
          <h1>Paranometer — Energielevel Tester</h1>
        </div>
      </div>

      <div class="mainrow">
        <div class="left">
          <div class="gauge-wrap" aria-hidden="false">
            <div class="gauge" id="gauge">
              <div class="gauge-face">
                <div class="gauge-arc"></div>
                <div class="ticks" id="ticks"></div>
                <div class="needle-wrap">
                  <div class="needle" id="needle" style="--angle:-90deg;"></div>
                </div>
                <div class="gauge-center" aria-hidden="true"></div>
              </div>
            </div>
          </div>

          <div class="controls">
            <button class="primary" id="startBtn">Energielevel testen</button>
            <button class="ghost" id="stopBtn" style="display:none">Stopp</button>
            <button class="ghost" id="resultBtn" style="display:none">Ergebnis anzeigen</button>
            <div style="flex:1"></div>
            <div class="small" id="status">Bereit</div>
          </div>

          <div class="meter" aria-hidden="false">
            <div style="display:flex; align-items:center; gap:10px; width:100%;">
              <div style="min-width:86px; font-size:13px; color:rgba(200,255,220,0.95)">Paranormales Energielevel</div>
              <div class="bar" aria-hidden="true"><i id="barFill"></i></div>
              <div style="width:56px; text-align:right; font-weight:700; color:var(--neon-2)" id="percentText">0%</div>
            </div>
          </div>
        </div>

        <div class="right">
          <h3 style="margin:0 0 8px 0; color:var(--neon-2)">Live-Information</h3>
          <p style="margin:0 0 12px 0; color:rgba(200,255,220,0.9)">Je schriller der Ton, desto höher das erkannte Energielevel.</p>

          <div style="margin-top:14px; font-size:13px; color:rgba(200,255,220,0.85)">
            <strong>Interpretation</strong>
            <ul style="margin:8px 0 0 18px; padding:0; color:rgba(200,255,220,0.85)">
              <li>0–20%: Keine bemerkenswerte Aktivität</li>
              <li>21–50%: Leichte Störung — beobachte</li>
              <li>51–80%: Signifikante Präsenz möglich</li>
              <li>81–100%: Starke Aktivität — erhöhte Aufmerksamkeit empfohlen</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ergebnis -->
  <div class="modal-back" id="modalBack" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h2>Ergebnis — Paranormales Energieprofil</h2>
      <div class="desc" id="modalDesc">Lade...</div>
      <div class="row" style="margin-top:12px;">
        <div style="flex:1">
          <div class="small">Maximales Level (Peak)</div>
          <div class="bigval" id="modalPeak">—%</div>
        </div>
        <div style="flex:1">
          <div class="small">Letzter Messwert</div>
          <div class="bigval" id="modalLast">—%</div>
        </div>
      </div>
      <div class="meaning" id="modalMeaning">
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px;">
        <button class="ghost" id="modalClose">Zurück</button>
        <button class="primary" id="modalReset">Neu testen</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // CONFIG
  const MIN_FREQ = 50;
  const MAX_FREQ = 4000;
  const SMOOTH_TIME = 0.05;
  const VIBRATION_THRESHOLD_FREQ = 3000; // Hz -> start vibration/haptics
  const VIBRATION_COOLDOWN_MS = 900;

  // UI elements
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const resultBtn = document.getElementById('resultBtn');
  const statusEl = document.getElementById('status');
  const needle = document.getElementById('needle');
  const barFill = document.getElementById('barFill');
  const percentText = document.getElementById('percentText');
  const tiltRead = document.getElementById('tiltRead');
  const freqRead = document.getElementById('freqRead');
  const peakRead = document.getElementById('peakRead');
  const modeRead = document.getElementById('modeRead');
  const betaVal = document.getElementById('betaVal');
  const gammaVal = document.getElementById('gammaVal');
  const vibToggle = document.getElementById('vibToggle');
  const calmToggle = document.getElementById('calmToggle');

  const modalBack = document.getElementById('modalBack');
  const modalDesc = document.getElementById('modalDesc');
  const modalPeak = document.getElementById('modalPeak');
  const modalLast = document.getElementById('modalLast');
  const modalMeaning = document.getElementById('modalMeaning');
  const modalClose = document.getElementById('modalClose');
  const modalReset = document.getElementById('modalReset');

  // Audio
  let audioCtx = null;
  let osc = null;
  let masterGain = null;
  let filter = null;
  let running = false;

  // sensor
  let lastBeta = 0;
  let lastGamma = 0;
  let lastTilt = 0;
  let lastFreq = 0;

  // stats
  let peakPercent = 0;
  let recording = false;

  // vibration state
  let vibEnabled = true;
  let toneEnabled = true;
  let lastVibAt = 0;

  // helper clamp
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

  // Mapping tilt (0..90) -> frequency
  function tiltToFreq(tilt) {
    const t = clamp(tilt,0,90)/90;
    return MIN_FREQ + (MAX_FREQ - MIN_FREQ) * t;
  }
  // Frequency -> percent 0..100
  function freqToPercent(freq) {
    const p = (clamp(freq,MIN_FREQ,MAX_FREQ)-MIN_FREQ) / (MAX_FREQ - MIN_FREQ);
    return Math.round(p*100);
  }

  // needle: map percent 0..100 -> angle -90..+90
  function percentToAngle(percent) {
    return -90 + (percent/100)*180;
  }

  // Smooth frequency setter
  function setFrequencySmooth(value) {
    if (!audioCtx || !osc) return;
    const now = audioCtx.currentTime;
    try {
      osc.frequency.cancelScheduledValues(now);
      osc.frequency.setValueAtTime(osc.frequency.value || value, now);
      osc.frequency.linearRampToValueAtTime(value, now + SMOOTH_TIME);
    } catch(e) {
      try { osc.frequency.value = value; } catch(e){}
    }
  }

  // Start audio graph
  function startAudio() {
    if (running) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    osc = audioCtx.createOscillator();
    masterGain = audioCtx.createGain();
    filter = audioCtx.createBiquadFilter();

    osc.type = 'sine';
    osc.frequency.value = MIN_FREQ;

    filter.type = 'lowpass';
    filter.frequency.value = 2000;
    filter.Q.value = 0.7;

    masterGain.gain.value = 0.12;

    osc.connect(filter);
    filter.connect(masterGain);
    masterGain.connect(audioCtx.destination);

    try { osc.start(); } catch(e){}

    running = true;
    modeRead.textContent = 'Läuft';
    statusEl.textContent = 'Audio aktiv — Gerät kippen.';
    startBtn.style.display = 'none';
    stopBtn.style.display = 'inline-block';
    resultBtn.style.display = 'inline-block';
    recording = true;
  }

  function stopAudioClean() {
    if (!running) return;
    try { osc.stop(); } catch(e){}
    try { audioCtx.close(); } catch(e){}
    audioCtx = null; osc = null; masterGain = null; filter = null;
    running = false;
    recording = false;
    statusEl.textContent = 'Gestoppt';
    modeRead.textContent = 'Aus';
    startBtn.style.display = 'inline-block';
    stopBtn.style.display = 'none';
    resultBtn.style.display = 'none';
  }

  // Sensor handler
  function handleOrientation(ev) {
    if (!ev) return;
    const beta = (typeof ev.beta === 'number') ? ev.beta : 0;
    const gamma = (typeof ev.gamma === 'number') ? ev.gamma : 0;
    lastBeta = beta; lastGamma = gamma;

    // combine magnitude
    const absBeta = Math.abs(beta);
    const absGamma = Math.abs(gamma);
    let tilt = Math.sqrt(absBeta*absBeta + absGamma*absGamma) / Math.SQRT2;
    tilt = clamp(tilt,0,90);

    const freq = tiltToFreq(tilt);
    const percent = freqToPercent(freq);

    // update stats
    lastTilt = tilt;
    lastFreq = freq;
    if (percent > peakPercent) peakPercent = percent;

    // update UI values
    betaVal.textContent = beta.toFixed(1) + '°';
    gammaVal.textContent = gamma.toFixed(1) + '°';
    tiltRead.textContent = tilt.toFixed(1) + '°';
    freqRead.textContent = Math.round(freq) + ' Hz';
    peakRead.textContent = peakPercent + '%';
    percentText.textContent = percent + '%';
    barFill.style.width = percent + '%';

    // needle rotation
    const angle = percentToAngle(percent);
    needle.style.setProperty('--angle', angle + 'deg');
    // set explicit transform as fallback
    needle.style.transform = `rotate(${angle}deg)`;

    // add vibrating needle class when level very high
    if (percent >= 90) {
      needle.classList.add('vibrating');
    } else {
      needle.classList.remove('vibrating');
    }

    // audio update
    if (running && toneEnabled && audioCtx && osc) {
      setFrequencySmooth(freq);
      // adjust filter cutoff to make low frequencies darker
      const filterCut = clamp(Math.max(200, freq * 2), 200, 20000);
      try {
        filter.frequency.cancelScheduledValues(audioCtx.currentTime);
        filter.frequency.setValueAtTime(filter.frequency.value || filterCut, audioCtx.currentTime);
        filter.frequency.linearRampToValueAtTime(filterCut, audioCtx.currentTime + SMOOTH_TIME * 1.2);
      } catch(e){}
    }

    // vibration/haptics: only sparingly to avoid continuous buzzing
    const now = Date.now();
    if (vibEnabled && percent >= Math.round(freqToPercent(VIBRATION_THRESHOLD_FREQ)) && (now - lastVibAt) > VIBRATION_COOLDOWN_MS) {
      lastVibAt = now;
      // try navigator.vibrate
      try {
        if (navigator.vibrate) {
          navigator.vibrate([120]);
        }
      } catch(e){}
    }

    lastTilt = tilt;
  }

  // Permission flow for iOS
  async function requestSensorPermissionIfNeeded() {
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      try {
        const result = await DeviceOrientationEvent.requestPermission();
        return result === 'granted';
      } catch (err) {
        console.warn('DeviceOrientation permission request failed:', err);
        return false;
      }
    } else {
      return true;
    }
  }

  // Start button handler
  startBtn.addEventListener('click', async () => {
    statusEl.textContent = 'Fordere Sensor-Zugriff an...';
    const ok = await requestSensorPermissionIfNeeded();
    if (!ok) {
      statusEl.textContent = 'Sensor-Zugriff verweigert. Bitte Safari Einstellungen prüfen.';
      return;
    }

    // start audio and resume to unlock iOS audio
    try {
      if (!audioCtx) startAudio();
      else await audioCtx.resume();
    } catch (e) {
      console.warn('Audio Fehler', e);
      statusEl.textContent = 'Fehler beim Audio starten.';
      return;
    }

    // register sensor listener
    window.addEventListener('deviceorientation', handleOrientation, true);

    // Set UI
    statusEl.textContent = 'Läuft — kippe das Gerät.';
    modeRead.textContent = 'Läuft';
  });

  // Stop button handler
  stopBtn.addEventListener('click', () => {
    window.removeEventListener('deviceorientation', handleOrientation, true);
    stopAudioClean();
    statusEl.textContent = 'Gestoppt';
  });

  // Ergebnis button: show modal and pause audio
  resultBtn.addEventListener('click', () => {
    // pause audio
    try { if (audioCtx && audioCtx.state === 'running') audioCtx.suspend(); } catch(e){}
    statusEl.textContent = 'Ergebnis angezeigt';
    // show modal & content
    showResult();
  });

  function showResult() {
    modalBack.style.display = 'flex';
    modalBack.setAttribute('aria-hidden','false');
    modalDesc.textContent = "Analyse des letzten Messlaufs:";
    modalPeak.textContent = peakPercent + '%';
    modalLast.textContent = freqToPercent(lastFreq) + '%';

    // interpret
    const p = peakPercent;
    let meaning = '';
    if (p <= 20) {
      meaning = "Geringe Aktivität — Es gibt keine belastbaren Hinweise für paranormale Präsenz. Die Umgebung ist ruhig.";
    } else if (p <= 50) {
      meaning = "Leichte Aktivität — Schwache Einflüsse wurden registriert. Beobachten Sie das Umfeld weiter.";
    } else if (p <= 80) {
      meaning = "Signifikante Aktivität — Mehrere Indikatoren sprechen für eine mögliche Präsenz. Vorsicht und Dokumentation empfohlen.";
    } else {
      meaning = "Starke Aktivität — Deutliche energetische Signaturen. Reduzieren Sie Störungen, dokumentieren Sie Ort und Zeit, und verhalten Sie sich bedacht.";
    }
    modalMeaning.textContent = meaning;
  }

  modalClose.addEventListener('click', () => {
    modalBack.style.display = 'none';
    modalBack.setAttribute('aria-hidden','true');
    statusEl.textContent = 'Lauf pausiert — Neues Testen mit „Energielevel testen“.';
  });

  modalReset.addEventListener('click', () => {
    modalBack.style.display = 'none';
    modalBack.setAttribute('aria-hidden','true');
    // reset stats and restart
    peakPercent = 0;
    peakRead.textContent = '—';
    percentText.textContent = '0%';
    barFill.style.width = '0%';
    betaVal.textContent = '—°'; gammaVal.textContent = '—°'; tiltRead.textContent = '—°'; freqRead.textContent = '— Hz';
    // resume sensor & audio
    try {
      if (!audioCtx) startAudio();
      else audioCtx.resume();
      window.addEventListener('deviceorientation', handleOrientation, true);
      statusEl.textContent = 'Neu gestartet — kippe das Gerät.';
    } catch(e){
      statusEl.textContent = 'Fehler beim Neustart.';
    }
  });

  // toggles
  vibToggle.addEventListener('click', () => {
    vibEnabled = !vibEnabled;
    vibToggle.textContent = 'Vibration: ' + (vibEnabled ? 'AN' : 'AUS');
  });
  calmToggle.addEventListener('click', () => {
    toneEnabled = !toneEnabled;
    calmToggle.textContent = 'Ton: ' + (toneEnabled ? 'AN' : 'AUS');
    if (!toneEnabled && audioCtx && audioCtx.state === 'running') {
      // mute master gain
      if (masterGain) masterGain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    } else if (toneEnabled && masterGain && audioCtx && audioCtx.state === 'running') {
      masterGain.gain.setValueAtTime(0.12, audioCtx.currentTime);
    }
  });

  // set ticks (0,25,50,75,100)
  const ticksEl = document.getElementById('ticks');
  function createTicks() {
    ticksEl.innerHTML = '';
    const labels = [0,25,50,75,100];
    labels.forEach(p => {
      const el = document.createElement('div');
      el.className = 'tick';
      const angle = percentToAngle(p);
      el.style.transform = `rotate(${angle}deg) translateY(-2px)`;
      const lbl = document.createElement('div');
      lbl.className = 'lbl';
      lbl.textContent = p + '%';
      lbl.style.transform = `rotate(${-angle}deg)`; // keep label upright
      el.appendChild(lbl);
      ticksEl.appendChild(el);
    });
  }
  createTicks();

  // friendly fallback
  setTimeout(() => {
    if (typeof DeviceOrientationEvent === 'undefined' && typeof window.DeviceMotionEvent === 'undefined') {
      statusEl.textContent = 'DeviceOrientation/DeviceMotion wird von diesem Gerät/Browser nicht unterstützt.';
    }
  }, 800);

  // best-effort resume on touchend
  document.body.addEventListener('touchend', async () => {
    if (audioCtx && audioCtx.state === 'suspended' && running) {
      try { await audioCtx.resume(); } catch(e){}
    }
  }, {passive:true});

  // clean unload
  window.addEventListener('pagehide', () => {
    try { window.removeEventListener('deviceorientation', handleOrientation, true); } catch(e){}
    try { if (audioCtx) audioCtx.close(); } catch(e){}
  });

})();
</script>
</body>
</html>
